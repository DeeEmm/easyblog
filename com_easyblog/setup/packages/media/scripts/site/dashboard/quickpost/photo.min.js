EasyBlog.module("site/dashboard/quickpost/photo",function(a){var e=this;EasyBlog.require().library("plupload2").script("site/vendors/webcam").done(function(p){EasyBlog.Controller("Quickpost.Form.Photo",{defaultOptions:{"{capture}":"[data-photo-camera-capture]","{canvas}":"[data-photo-camera-canvas]","{preview}":"[data-photo-camera-preview]","{recapture}":"[data-photo-camera-recapture]",dataType:"upload","{tabs}":"[data-quickpost-photo-tab]","{tabUpload}":"[data-quickpost-photo-tab-upload]","{tabWebcam}":"[data-quickpost-photo-tab-webcam]","{uri}":"[data-photo-uri]","{container}":"[data-photo-upload-container]","{uploadPreview}":"[data-photo-upload-preview]","{reupload}":"[data-photo-upload-reupload]","{loading}":"[data-photo-upload-loading]","{form}":"[data-microblog-form]","{link}":"[data-quickpost-link]","{title}":"[data-quickpost-title]","{content}":"[data-quickpost-content]","{tags}":"[data-quickpost-tags]","{privacy}":"[data-quickpost-privacy]","{category}":"[data-quickpost-category]","{tagSuggest}":"[data-quickpost-form][data-type='photo'] [data-eb-composer-tags]"}},function(c,a,t){return{init:function(){c.registerUploader(),c.hasFlash()||p("ul.eb-quick-photo-tab").hide(),c.parent.implementTags(c.tagSuggest())},registerUploader:function(){(t=c.container().plupload2({uploadFrom:"fromQuickPost"},!1)).bind("FilesAdded",function(a,e){t.start(),c.toggleLoading()}),t.bind("FileUploaded",function(a,e,t){c.toggleLoading();var o=JSON.parse(t.response).media,i=new Image,t=o.meta.url;"/"!=t.charAt(0)&&(t="/"+t),p(i).attr("src",t),c.uri().val(o.uri),c.container().addClass("hidden"),c.uploadPreview().removeClass("hidden").append(i),c.reupload().removeClass("hidden")})},toggleLoading:function(){c.container().toggleClass("hidden"),c.loading().toggleClass("hidden")},hasFlash:function(){var e=!1;try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash")&&(e=!0)}catch(a){navigator.mimeTypes&&null!=navigator.mimeTypes["application/x-shockwave-flash"]&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin&&(e=!0)}return e},"{reupload} click":function(a,e){c.reupload().addClass("hidden"),c.container().removeClass("hidden"),c.uploadPreview().addClass("hidden").html("")},"{tabs} click":function(a,e){c.options.dataType=p(a).data("type"),"photo"==c.options.dataType&&t.init()},webcamStarted:!1,"{capture} click":function(a,e){webcam.capture()},"{recapture} click":function(a,e){c.capture().removeClass("hidden"),c.recapture().addClass("hidden"),c.canvas().removeClass("hidden"),c.preview().find("img").remove(),c.preview().addClass("hidden")},"{tabWebcam} click":function(a,e){var n=0,d=null,l=[],r=c.canvas().data("key"),s=document.createElement("canvas");s.setAttribute("width",320),s.setAttribute("height",240),saveCallback=s.toDataURL?(d=s.getContext("2d"),l=d.getImageData(0,0,320,240),function(a){for(var e=a.split(";"),t=l,o=0;o<320;o++){var i=parseInt(e[o]);t.data[n+0]=i>>16&255,t.data[n+1]=i>>8&255,t.data[n+2]=255&i,t.data[n+3]=255,n+=4}307200<=n&&(d.putImageData(t,0,0),EasyBlog.ajax("site/controllers/quickpost/saveWebcam",{key:r,type:"data",image:s.toDataURL("image/png")}).done(function(a){var e=a.url,t=new Image;c.preview().removeClass("hidden"),p(t).attr("src",e).appendTo(c.preview()),c.canvas().addClass("hidden"),c.capture().addClass("hidden"),c.recapture().removeClass("hidden"),c.uri().val(a.uri)}),n=0)}):function(a){l.push(a),307200<=(n+=1280)&&(p.post("/upload.php",{type:"pixel",image:l.join("|")}),n=0)},c.webcamStarted||(c.canvas().webcam({width:320,height:240,mode:"callback",swffile:p.basePath+"/media/com_easyblog/scripts/site/vendors/jscam.swf",onSave:saveCallback,onCapture:function(){webcam.save()}}),c.webcamStarted=!0)},uploaderInitialized:!1,initializeUploader:function(){c.uploaderInitialized||(t.init(),c.uploaderInitialized=!0)},"{self} onTabChange":function(a,e,t){c.initializeUploader()},"{self} onPublishQuickPost":function(a,e,t,o,i){"photo"==o&&(c.tagSuggest().controller().fillTags(),t.data={dataType:c.options.dataType,title:p(i).find(c.title.selector).val(),type:"photo",content:p(i).find(c.content.selector).val(),link:p(i).find(c.link.selector).val(),tags:p(i).find(c.tags.selector).val(),privacy:p(i).find(c.privacy.selector).val(),category:p(i).find(c.category.selector).val(),uri:c.uri().val()})},"{self} onClearForm":function(a,e,t,o,i){"photo"==o&&(c.tagSuggest().controller().clearTags(),p(i).find(c.title.selector).val(""),p(i).find(c.content.selector).val(""),p(i).find(c.link.selector).val(""),p(i).find(c.tags.selector).val(""),c.uri().val(""),c.reupload().addClass("hidden"),c.container().removeClass("hidden"),c.uploadPreview().addClass("hidden").html(""))}}}),e.resolve()})});