EasyBlog.module("site/dashboard/quickpost/tags",function(d){var t=this,n=40,l=13,m=27,p=37,f=39,v=38,x={38:"up",40:"down",37:"left",39:"right"};EasyBlog.require().library("textboxlist").script("shared/nearest").done(function(){EasyBlog.Controller("Quickpost.Form.Tags",{defaultOptions:{templates:{},"{tagTemplate}":"[data-tag-template]",readOnly:!1,"{tags}":"[data-eb-composer-tags]","{tag}":".textboxlist-item","{total}":"[data-eb-composer-tags-total]","{count}":"[data-eb-composer-tags-count]","{suggestions}":".eb-composer-tags-suggestions","{selection}":".eb-composer-tags-selection","{toggleButton}":"[data-eb-composer-tags-toggle-button]","{itemgroup}":".eb-composer-tags-selection-itemgroup","{item}":".eb-composer-tags-selection-itemgroup > div","{textfield}":"[data-textboxlist-textField]","{textboxlist}":"[data-eb-composer-tags-textboxlist]","{jsondata}":"[data-eb-composer-tags-jsondata]","{tagsInput}":"[data-quickpost-tags]"}},function(r,o,t,c,u,g){return{init:function(){o.readOnly=0<d("[data-eb-composer-tags-readonly]").length,d.template("composer/textboxlist/item",d("[data-tag-template]").detach().html()),u=r.selection,c=r.suggestions;var t=parseInt(r.tags().attr("data-eb-composer-tags-max"))||null;r.textboxlist().textboxlist({component:"eb",max:t,ignoreLocked:!0,view:{item:"composer/textboxlist/item"},filterItem:function(t){return d.isString(t)?g.sanitize(t):(t.title=g.sanitize(t.title),t)}}),g=r.tagger=d.extend(r.textboxlist().textboxlist("controller"),r.tagger),c.populate("",!0)},tagger:{sanitize:function(t){return d.trim(t).replace(/,/g,"")},addLockedItem:function(t){t=d.trim(t);var e=g.get(t),i=e&&!e.locked;e&&g.deleteItem(e.id),g.addItem({id:d.uid("item-"),title:t,key:g.getItemKey(t),locked:!0,assigned:i},!0)}},"{textfield} keydown":function(t,e){var i=e.which,a=u.activeItem;switch(i){case v:case n:case p:case f:var s=x[i];(0<a.length||"down"==s)&&(c.navigate(s),e.preventDefault());break;case m:0<a.length?u.deactivate(a):r.suggestions().hasClass("is-showing")?c.collapse():t.val("");break;case l:if(0<a.length)return u.use(a),void e.preventDefault();o.readOnly&&e.preventDefault();break;default:c.populateFromTextfield()}},"{item} mouseover":function(t){u.deactivate(),u.activate(t)},"{item} mouseout":function(t){u.deactivate()},"{item} click":function(t){u.use(t)},"{textboxlist} addItem":function(t,e,i){d(u.get(i.title)).addClass("is-used")},"{textboxlist} removeItem":function(t,e,i){d(u.get(i.title)).removeClass("is-used")},"{textboxlist} listChange":d.debounce(function(){c.refresh();var t=r.tagger.getAddedItems().length;r.count().text(t)},15),"{toggleButton} click":function(t){c[r.suggestions().hasClass("is-showing")?"collapse":"expand"]()},suggestions:{index:0,tags:[],expand:function(){c.tick++,r.suggestions().addClass("is-showing")},collapse:function(){c.tick++,r.suggestions().removeClass("is-showing")},refresh:function(){var t=r.item(":not(.is-used)");r.suggestions().toggleClass("is-empty",t.length<1),c.count()},show:function(){c.tick++,c.refresh(),c.expand()},hide:function(){var t=++c.tick;c.collapse(),setTimeout(function(){t===c.tick&&c.reset()},500)},set:function(t){t.length<1?(c.hide(),c.tags=[]):(c.reset(),c.tags=t)},reset:function(){c.tags=[],c.i=0,r.itemgroup().empty()},pid:0,tick:0,currentQuery:null,query:d.memoize(function(t){return EasyBlog.ajax("site/views/tags/suggest",{search:t}).fail(function(){})}),populate:function(t,e){c.tick++;var i=++c.pid;c.currentQuery&&c.currentQuery.abort(),t=g.sanitize(t),r.suggestions().addClass("is-busy"),c.currentQuery=c.query(t).done(function(t){c.pid===i&&(c.set(t),c.suggest(e))}).fail(function(){c.pid}).always(function(){r.suggestions().removeClass("is-busy"),c.currentQuery=null})},populateTimer:null,populateFromTextfield:function(){c.tick++,clearTimeout(c.populateTimer),setTimeout(function(){var t=r.textfield(),e=g.sanitize(t.val());""===e?(c.hide(),c.populate("",!0)):c.query.cache.hasOwnProperty(e)?c.populate(e):c.populateTimer=setTimeout(function(){c.populate(e)},250)},1)},suggest:function(t){var e=c.tags;if(!(e.length<1)){for(var i,a,s,o=0,n=e.length,l=[];o<n&&(i=e[c.i]);)a=i.title,s=u.get(a)||u.create(a),l.push(s),g.get(a)?d(s).addClass("is-used"):o++,c.i++;r.itemgroup().append(l),t?c.refresh():c.show()}},navigate:function(t){var e=r.item(),i=r.itemgroup(),a=u.activeItem,e=d(a[0]||r.textfield()[0]).nearest(e,t);0<e.length?(u.activate(e),i.scrollIntoView(e)):0<a.length&&("down"==t&&(c.suggest(),i.scrollIntoView(a)),"up"==t&&u.deactivate())},count:function(){var t=d.pluck(c.tags,"title"),e=d.keys(g.itemsByTitle),e=d.without.apply(null,[t].concat(e)).length;r.total().text(e+"")}},selection:{items:{},activeItem:d(),create:function(t){var e=document.createElement("div");return e.innerHTML=t,u.items[t]=e},get:function(t){return u.items[t]},activate:function(t){u.deactivate(),u.activeItem=t.addClass("active")},deactivate:function(t){u.activeItem.removeClass("active"),u.activeItem=d()},use:function(t){var e=(t=d(t)).text();g.addItem(e)&&(r.textfield().focus(),t.is(u.activeItem)&&(nextItem=t.next(r.item)[0]||t.prev(r.item)[0],u.deactivate(t),nextItem&&u.activate(d(nextItem))),r.textfield().val(""),c.refresh())}},fillTags:function(){var t=r.tagger.getAddedItems(),t=d.pluck(t,"title").join(",");r.tagsInput().val(t)},clearTags:function(){r.tagger.clearItems(),r.textfield().val(""),c.refresh(),c.reset(),c.hide(),c.populateFromTextfield(),r.tagsInput().val("")}}}),t.resolve()})});