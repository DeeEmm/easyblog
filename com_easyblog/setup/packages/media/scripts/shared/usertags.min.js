EasyBlog.module("shared/usertags",function(l){var e=this,n=40,o=13,c=27,d=37,m=39,f=38,p={38:"up",40:"down",37:"left",39:"right"};EasyBlog.require().library("textboxlist").script("shared/nearest","admin/user/suggest").done(function(){EasyBlog.Controller("Html.Usertags",{defaultOptions:{templates:{},"{userTemplate}":"[data-usertags-template]",readonly:!1,"{usersForm}":"[data-eb-usertags]","{total}":"[data-eb-usertags-total]","{count}":"[data-eb-usertags-count]","{suggestions}":"[data-eb-usertags-suggestions]","{selection}":"[data-eb-usertags-selection]","{toggleButton}":"[data-eb-usertags-toggle-button]","{itemgroup}":"[data-eb-usertags-selection-itemgroup]","{item}":"[data-eb-usertags-selection-itemgroup] > div","{textfield}":"[data-textboxlist-textField]","{textboxlist}":"[data-eb-usertags-textboxlist]","{jsondata}":"[data-eb-usertags-jsondata]"}},function(g,e,t,u,r){return{init:function(){u=g.selection,suggestions=g.suggestions,r=g.taggers,l.template("textboxlist/item",g.userTemplate().detach().html());var e=parseInt(g.usersForm().attr("data-eb-usertags-max"))||10,t=g.usersForm().attr("data-eb-usertags-fieldName").toString()||"item";g.textboxlist().textboxlist({name:t+"[]",component:"eb",max:e,ignoreLocked:!0,view:{item:"textboxlist/item"}}),r=g.taggers=l.extend(g.textboxlist().textboxlist("controller"),g.taggers);var s=JSON.parse(g.jsondata().val());for(i=0;i<s.length;i++)r.addItem({id:s[i].id,title:s[i].username,key:s[i].id,locked:!1});window.tagz=g},"{textfield} keydown":function(e,t){var s=t.which,i=u.activeItem;switch(s){case f:case n:case d:case m:var a=p[s];(0<i.length||"down"==a)&&(suggestions.navigate(a),t.preventDefault());break;case c:0<i.length?u.deactivate(i):g.suggestions().hasClass("is-showing")?suggestions.collapse():e.val("");break;case o:t.preventDefault();break;default:suggestions.populateFromTextfield()}},"{textboxlist} addItem":function(e,t,s){l(u.get(s.title)).addClass("is-used")},"{textboxlist} removeItem":function(e,t,s){s.assigned?tagger.addItem(s.title):l(u.get(s.title)).removeClass("is-used")},"{textboxlist} listChange":l.debounce(function(){suggestions.refresh();var e=g.taggers.getAddedItems().length;g.count().text(e)},15),"{item} mouseover":function(e){u.deactivate(),u.activate(e)},"{item} mouseout":function(e){u.deactivate()},"{item} click":function(e){u.use(e)},suggestions:{usertags:[],pid:0,tick:0,currentQuery:null,populateTimer:null,query:l.memoize(function(e){return EasyBlog.ajax("admin/views/bloggers/suggest",{search:e,max:parseInt(g.usersForm().attr("data-eb-usertags-max"))||10}).fail(function(){})}),set:function(e){e.length<1?(suggestions.hide(),suggestions.usertags=[]):(suggestions.reset(),suggestions.usertags=e)},collapse:function(){suggestions.tick++,g.suggestions().removeClass("is-showing")},hide:function(){var e=++suggestions.tick;suggestions.collapse(),setTimeout(function(){e===suggestions.tick&&suggestions.reset()},500)},reset:function(){suggestions.usertags=[],suggestions.i=0,g.itemgroup().empty()},refresh:function(){var e=g.item(":not(.is-used)");g.suggestions().toggleClass("is-empty",e.length<1),suggestions.count()},show:function(){suggestions.tick++,suggestions.refresh(),suggestions.expand()},expand:function(){suggestions.tick++,g.suggestions().addClass("is-showing")},count:function(){var e=l.pluck(suggestions.usertags,"name"),t=l.keys(r.itemsByTitle),t=l.without.apply(null,[e].concat(t)).length;g.total().text(t+"")},populateFromTextfield:function(){suggestions.tick++,clearTimeout(suggestions.populateTimer),setTimeout(function(){var e=g.textfield(),t=r.sanitize(e.val());""===t?(suggestions.hide(),suggestions.populate("",!0)):suggestions.query.cache.hasOwnProperty(t)?suggestions.populate(t):suggestions.populateTimer=setTimeout(function(){suggestions.populate(t)},250)},1)},populate:function(e,t){suggestions.tick++;var s=++suggestions.pid;suggestions.currentQuery&&suggestions.currentQuery.abort(),e=r.sanitize(e),g.suggestions().addClass("is-busy"),suggestions.currentQuery=suggestions.query(e).done(function(e){suggestions.pid===s&&(suggestions.set(e),suggestions.suggest(t))}).fail(function(){suggestions.pid}).always(function(){g.suggestions().removeClass("is-busy"),suggestions.currentQuery=null})},suggest:function(e){if(r.getAddedItems().length!=r.options.max){var t=suggestions.usertags;if(!(t.length<1)){for(var s,i,a=0,n=t.length,o=[];a<n&&(s=t[suggestions.i]);)name=s.name,i=u.get(name)||u.create(s),o.push(i),r.get(name)?l(i).addClass("is-used"):a++,suggestions.i++;g.itemgroup().append(o),e?suggestions.refresh():suggestions.show()}}}},taggers:{sanitize:function(e){return l.trim(e).replace(/,/g,"")}},selection:{items:{},activeItem:l(),create:function(e){var t=document.createElement("div");return t.innerHTML=e.name,t.setAttribute("data-id",e.userId),u.items[e.name]=t},get:function(e){return u.items[e]},activate:function(e){u.deactivate(),u.activeItem=e.addClass("active")},deactivate:function(e){u.activeItem.removeClass("active"),u.activeItem=l()},use:function(e){var t=(e=l(e)).text(),s=e.data("id");r.addItem({id:s,title:t,key:s,locked:!1})&&(g.textfield().focus(),e.is(u.activeItem)&&(nextItem=e.next(g.item)[0]||e.prev(g.item)[0],u.deactivate(e),nextItem&&u.activate(l(nextItem))),suggestions.refresh(),g.textfield().val(""))}}}}),e.resolve()})});